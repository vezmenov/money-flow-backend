name: Generate Angular SDK

on:
  push:
    paths:
      - openapi.yaml
      - package.json
      - .github/workflows/sdk.yml
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Generate SDK
        run: npm run sdk:generate

      - name: Pack SDK
        run: |
          cd sdk
          # npm pack runs "prepare" even with --ignore-scripts. We don't need build artifacts
          # for pushing sources into frontend, so strip prepare to avoid missing dev deps (ng-packagr).
          node - <<'NODE'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          if (pkg.scripts && pkg.scripts.prepare) {
            delete pkg.scripts.prepare;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          }
          NODE
          npm pack --ignore-scripts

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: money-flow-sdk
          path: sdk/*.tgz

      - name: Push SDK to frontend repo
        env:
          FRONTEND_REPO: vezmenov/money-flow
          FRONTEND_SDK_PATH: src/app/sdk
          FRONTEND_TOKEN: ${{ secrets.FRONTEND_TOKEN }}
        run: |
          if [ -z "$FRONTEND_TOKEN" ]; then
            echo "FRONTEND_TOKEN is not set" >&2
            exit 1
          fi
          git clone "https://x-access-token:${FRONTEND_TOKEN}@github.com/${FRONTEND_REPO}.git" frontend
          cd frontend
          rm -rf "${FRONTEND_SDK_PATH}"
          mkdir -p "${FRONTEND_SDK_PATH}"
          tar -xzf ../sdk/*.tgz --strip-components=1 -C "${FRONTEND_SDK_PATH}"
          git config user.name "money-flow-bot"
          git config user.email "money-flow-bot@users.noreply.github.com"
          git add "${FRONTEND_SDK_PATH}"
          if git diff --cached --quiet; then
            echo "No SDK changes to push."
            exit 0
          fi
          git commit -m "chore(sdk): обновить Angular SDK"
          git push origin HEAD:main
